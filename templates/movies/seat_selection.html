{% extends "users/basic.html" %}
{% block content %}
<div class="container mt-5">
  <div class="row">
    <div class="col-lg-10 mx-auto">
      <!-- Movie and Theater Info -->
      <div class="card mb-4 border-0 shadow-sm" style="background: #222;">
        <div class="card-body p-4 text-white">
          <div class="d-flex justify-content-between align-items-center flex-wrap">
            <div>
              <h2 class="mb-1">{{ theater.movie.name }}</h2>
              <p class="text-muted mb-0">
                {{ theater.name }} | {{ theater.time|date:"D, d M, h:i A" }}
              </p>
            </div>
            <div class="mt-3 mt-md-0">
              <span class="badge badge-secondary p-2 mr-2">2D</span>
              <span class="badge badge-secondary p-2">English</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Seat Selection -->
      <div class="card border-0 shadow-lg">
        <div class="card-body p-5" style="background: #1a1a1a;">

          {% if error %}
          <div class="alert alert-warning mb-4 text-center border-0 shadow-sm">
            <i class="fa fa-exclamation-circle mr-2"></i>{{ error }}
          </div>
          {% endif %}

          <form method="POST" id="bookingForm" onsubmit="addBtnLoader(this)">
            {% csrf_token %}

            <!-- 1. Screen Indicator (CSS Pure) -->
            <div class="screen-indicator"></div>
            <p class="screen-text">SCREEN THIS WAY</p>

            <!-- 2. Interactive Seat Grid -->
            <div class="seat-grid mb-5">
              {% for seat in seats %}
              <!-- Wrapper for positioning -->
              <div class="seat-wrapper text-center">

                {% if seat.status == 'available' %}
                <!-- Real Input (Hidden) -->
                <input type="checkbox" name="seats" value="{{ seat.id }}" class="seat-checkbox" id="seat-{{ seat.id }}">
                <!-- Visual Label -->
                <label for="seat-{{ seat.id }}"
                  class="seat-label d-flex align-items-center justify-content-center text-white mb-0 mx-auto">
                  <small>{{ seat.seat_number }}</small>
                </label>

                {% elif seat.status == 'locked' %}
                <!-- Locked State -->
                <div class="seat-label locked d-flex align-items-center justify-content-center text-dark mx-auto"
                  title="Identifying...">
                  <small>{{ seat.seat_number }}</small>
                </div>

                {% else %}
                <!-- Booked State -->
                <div class="seat-label booked d-flex align-items-center justify-content-center text-dark mx-auto"
                  title="Sold">
                  <small>{{ seat.seat_number }}</small>
                </div>

                {% endif %}
              </div>
              {% endfor %}
            </div>

            <!-- 3. Improved Legend -->
            <div class="seat-legend">
              <div class="legend-item">
                <div class="legend-box" style="background-color: #444;"></div>
                <span>Available</span>
              </div>
              <div class="legend-item">
                <div class="legend-box" style="background-color: var(--primary-color);"></div>
                <span>Selected</span>
              </div>
              <div class="legend-item">
                <div class="legend-box" style="background-color: #ddd;"></div>
                <span>Sold</span>
              </div>
            </div>

            <!-- 4. Action Button with Loading State -->
            <div class="text-center border-top pt-4 border-secondary">
              <p class="text-muted small mb-3">Please select your seats to proceed</p>
              <button type="submit" class="btn btn-primary btn-lg px-5 shadow-sm" id="payBtn">
                Proceed to Pay
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Simple btn loader
  function addBtnLoader(form) {
    const btn = document.getElementById('payBtn');
    // Check if seats are selected
    const checked = form.querySelectorAll('input[name="seats"]:checked').length;
    if (checked === 0) {
      // Let backend handle the error render, but visually we can't block standard submit 
      // unless we want JS validation. Requirements say NO LOGIC CHANGE.
      // So we allow submit, backend returns error.
    } else {
      btn.classList.add('btn-loading');
      btn.innerText = "Processing...";
    }
  }

  // Polling for real-time updates (reusing existing logic structure)
  const statusUrl = "{% url 'check_seat_status' theater.id %}";

  setInterval(function () {
    fetch(statusUrl)
      .then(r => r.json())
      .then(data => {
        data.seats.forEach(s => {
          // If a seat becomes non-available and wasn't before
          if (s.status !== 'available') {
            const input = document.getElementById('seat-' + s.id);
            if (input) {
              // If I haven't selected it myself, disable it visually so I don't try to book
              if (!input.checked) {
                const label = document.querySelector(`label[for="seat-${s.id}"]`);
                if (label) {
                  label.className = "seat-label booked d-flex align-items-center justify-content-center text-dark mx-auto";
                  label.title = "Just Sold";
                  // Remove input interactivity
                  input.disabled = true;
                }
              }
            }
          }
        });
      })
      .catch(e => console.log('Polling inactive'));
  }, 4000);
</script>
{% endblock %}