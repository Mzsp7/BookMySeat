{% extends "users/basic.html" %}
{% block content %}

<style>
  /* Scoped Theater List Styles */
  .theatre-card {
    background: #1f1f1f;
    border: none;
    border-radius: 8px;
    margin-bottom: 20px;
    padding: 20px;
    transition: transform 0.2s;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
  }

  .theatre-card:hover {
    transform: translateY(-2px);
    background: #252525;
  }

  .time-slot {
    background: transparent;
    border: 1px solid #444;
    color: #0dcaf0;
    /* Info Blue */
    padding: 8px 16px;
    border-radius: 4px;
    display: inline-block;
    margin-right: 10px;
    margin-bottom: 10px;
    text-decoration: none;
    transition: all 0.2s;
  }

  .time-slot:hover {
    background: #0dcaf0;
    color: #000;
    text-decoration: none;
    transform: scale(1.05);
  }

  .feature-icon {
    font-size: 0.9rem;
    color: #888;
    margin-right: 15px;
  }

  .feature-icon i {
    margin-right: 6px;
  }
</style>

<div class="py-5">
  <!-- Movie Title -->
  <div class="text-center mb-5">
    <h2 class="font-weight-bold display-4">{{ movie.name }}</h2>
    <p class="text-muted lead">{{ movie.genre }} | {{ movie.language }}</p>
  </div>

  <!-- Watch Trailer Button -->
  {% if movie.trailer_url %}
  <div class="text-center mb-4">
    <button type="button" class="btn btn-danger btn-lg" data-toggle="modal" data-target="#trailerModal">
      <i class="fas fa-play-circle"></i> Watch Trailer
    </button>
  </div>
  {% endif %}

  <!-- Conditional Check for Theaters -->
  {% if theaters %}
  <!-- Theater List and Showtimes -->
  <div class="row">
    <div class="col-lg-10 mx-auto">
      {% for theater in theaters %}
      <div class="theatre-card text-white">
        <div class="row align-items-center mb-3">
          <div class="col-md-6">
            <h4 class="mb-1 font-weight-bold" style="color: #e50914;">
              <i class="fas fa-heart text-danger mr-2"></i>{{ theater.name }}
            </h4>
            <div class="feature-icon mt-2">
              <span><i class="fas fa-mobile-alt text-success"></i> M-Ticket</span>
              <span><i class="fas fa-hamburger text-warning"></i> F&B</span>
            </div>
          </div>
        </div>

        <div class="d-flex flex-wrap align-items-center">
          <div class="mr-3 mb-2 text-muted small">Showtimes:</div>
          <a href="{% url 'book_seats' theater.id %}" class="time-slot shadow-sm">
            {{ theater.time|date:"h:i A" }}
            <br><small class="text-white-50">4K Dolby</small>
          </a>
          <!-- Mocking extra slots for realism if we had them, strictly visual -->
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
  {% else %}
  <!-- Message when no theaters are available -->
  <div class="text-center py-5">
    <div class="empty-state">
      <i class="fas fa-video-slash empty-icon text-muted"></i>
      <h4 class="text-muted">No theaters showing this movie yet.</h4>
      <a href="{% url 'movie_list' %}" class="btn btn-outline-light mt-3">Check Other Movies</a>
    </div>
  </div>
  {% endif %}

  <div class="text-center mt-5 text-muted small">
    <i class="fas fa-shield-alt text-success"></i> 100% Safe & Secure Payments
  </div>
</div>

<!-- Trailer Modal -->
{% if movie.trailer_url %}
<div class="modal fade" id="trailerModal" tabindex="-1" role="dialog" aria-labelledby="trailerModalLabel"
  aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="trailerModalLabel">{{ movie.name }} - Trailer</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body p-0">
        <div class="embed-responsive embed-responsive-16by9">
          <iframe id="trailerIframe" class="embed-responsive-item" src="" allowfullscreen></iframe>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Extract YouTube video ID from URL
  function getYouTubeID(url) {
    const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
    const match = url.match(regExp);
    return (match && match[2].length === 11) ? match[2] : null;
  }

  // Load trailer when modal opens
  $('#trailerModal').on('show.bs.modal', function () {
    const trailerUrl = "{{ movie.trailer_url }}";
    const videoId = getYouTubeID(trailerUrl);
    if (videoId) {
      $('#trailerIframe').attr('src', `https://www.youtube.com/embed/${videoId}?autoplay=1`);
    }
  });

  // Stop trailer when modal closes
  $('#trailerModal').on('hide.bs.modal', function () {
    $('#trailerIframe').attr('src', '');
  });
</script>
{% endif %}
{% endblock %}